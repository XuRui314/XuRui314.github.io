<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Diffusion 从入门到入土 | XuRui-Blog</title><meta name="author" content="zxr"><meta name="copyright" content="zxr"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Introduction Creating noise from data is easy; creating data from noise is generative modeling  — Songyang  这是一份关于Diffusion model的教程，和市面上很多教程不太一样的是，我会着重从high level的角度介绍如何去从0开始根据一些principle idea来推导出模型的">
<meta property="og:type" content="article">
<meta property="og:title" content="Diffusion 从入门到入土">
<meta property="og:url" content="https://xurui314.github.io/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/index.html">
<meta property="og:site_name" content="XuRui-Blog">
<meta property="og:description" content="Introduction Creating noise from data is easy; creating data from noise is generative modeling  — Songyang  这是一份关于Diffusion model的教程，和市面上很多教程不太一样的是，我会着重从high level的角度介绍如何去从0开始根据一些principle idea来推导出模型的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png">
<meta property="article:published_time" content="2023-07-01T06:00:32.000Z">
<meta property="article:modified_time" content="2023-07-07T15:20:46.828Z">
<meta property="article:author" content="zxr">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png"><link rel="shortcut icon" href="https://i.loli.net/2021/07/27/lSHRJbx7dYwTk8f.jpg"><link rel="canonical" href="https://xurui314.github.io/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Diffusion 从入门到入土',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-07-07 23:20:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/badge.css"><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/mouse.css"><link rel="stylesheet" href="/dist/APlayer.min.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/bilibiliBanner.css" media="defer" onload="this.media='screen'"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script async="" src="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2021/12/08/yTYthVwXD4IPbJ9.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">82</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">16</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页🍭</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 档案🌊</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签📑</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类🌈</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 好康的✨</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://ocw.mit.edu/"><i class="fa-fw fas fa-link"></i><span> 来学麻学</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-video"></i><span> zxrの追番计划</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RyOyXsKuUgI"><i class="fa-fw fas fa-heart"></i><span> zxr最爱滴up嘉倩</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://oskarstalberg.com/game/planet/planet.html"><span> Planet</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链💕</span></a></div><div class="menus_item"><a class="site-page" href="https://xurui314.github.io/aboutme/"><span> AboutMe🏂</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><span> 虫洞</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">XuRui-Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页🍭</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 档案🌊</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签📑</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类🌈</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 好康的✨</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://ocw.mit.edu/"><i class="fa-fw fas fa-link"></i><span> 来学麻学</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-video"></i><span> zxrの追番计划</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=RyOyXsKuUgI"><i class="fa-fw fas fa-heart"></i><span> zxr最爱滴up嘉倩</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://oskarstalberg.com/game/planet/planet.html"><span> Planet</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链💕</span></a></div><div class="menus_item"><a class="site-page" href="https://xurui314.github.io/aboutme/"><span> AboutMe🏂</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><span> 虫洞</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Diffusion 从入门到入土</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-07-01T06:00:32.000Z" title="Created 2023-07-01 14:00:32">2023-07-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-07-07T15:20:46.828Z" title="Updated 2023-07-07 23:20:46">2023-07-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Deep-Learning/">Deep Learning</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">9.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>42min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Diffusion 从入门到入土"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png');"></div><article class="post-content" id="article-container"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><blockquote>
<p>Creating noise from data is easy; creating data from noise is generative modeling  — Songyang</p>
</blockquote>
<p>这是一份关于Diffusion model的教程，和市面上很多教程不太一样的是，我会着重从high level的角度介绍如何去从0开始根据一些principle idea来推导出模型的结构，对于过于细节的math可能会一笔带过，因为对我来说这并不是重点。</p>
<p>Diffusion模型可以算是最近几年最为强大的生成模型，无论是理论推导，还是实际工程效果，无不透露出一种特殊的美感，我第一次接触diffusion模型其实并不是从变分框架的角度，而是从随机微分方程(SDE)的角度看待加噪和去噪的过程，这种随机中蕴含的确定性可逆的特性深深吸引了我，也驱使着我探究这份来源于物理学的美。</p>
<p>因为这个领域并没有自顶向下一次性提出一个完整的理论，实际上是由不同的视角逐步探索，最后收敛于同一个框架，用SDE去解释也是2021年才提出的，网上的很多tutorial对这个角度可能都不是很详细，为了记录我的思考过程，这篇blog是以一个自顶向下的SDE视角来解释Diffusion mdel，希望能对你有所帮助:p</p>
<p><img src="https://github.com/DrugowitschLab/ML-from-scratch-seminar/blob/master/DiffusionGenerativeModels/images/forward_diffusion_movie.gif?raw=true" style="zoom:80%;"></p>
<p><img src="https://github.com/DrugowitschLab/ML-from-scratch-seminar/blob/master/DiffusionGenerativeModels/images/reverse_diffusion_movie.gif?raw=true" style="zoom:80%;"></p>
<h2 id="SDE"><a href="#SDE" class="headerlink" title="SDE"></a>SDE</h2><h3 id="微分方程"><a href="#微分方程" class="headerlink" title="微分方程"></a>微分方程</h3><p>在现实的世界中，我们常常寻求变量间变化的直接关系，也就是想找到一种函数来描述变量间的联系，但是有时只能获得变量与变量间接变化的信息，而微分方程描述的就是这样包含导数的信息，微分方程的解就是变量间的直接函数关系。</p>
<p>下面以一阶微分方程举例，一般的形式是</p>
<script type="math/tex; mode=display">
y' = f(x, y)</script><p>例如：</p>
<script type="math/tex; mode=display">
y' = {x \over y} \\
y' = x - y^2</script><p>对于第一个微分方程，我们可以用分离变量的方法求解，但是对于第二个，是无法用初等函数表示解，也就是某种程度上不可解，对于这样不可解的微分方程，我们常用的几何法来绘制出“方向场”，而得到的解为“积分曲线”。</p>
<p>几何法就是在坐标平面上的每一点用“线素”来标示出该点的斜率，而 $(x,y)$点的斜率值就是 $y’=f(x,y)$ 。而积分曲线在其曲线的每个点上都和“线素”相切，它也就是微分方程解函数的图像。对于不同的初值，对应会有相应的解。下图以logistic differential equation $y’=cy(1-y)$ 示例</p>
<script type="math/tex; mode=display">
\underbrace{\frac{d}{d t} y(t)}_{\text {change over time }}=\underbrace{f(t, y(t))}_{\text {value of change }}</script><p><img src="\image\Diffusion_image6.png" alt="image-20230701230212877" style="zoom: 50%;"></p>
<p>这个例子是有解析解的，对应如果我们需要计算 $T$ 时刻的 $y$ 值，只需要</p>
<script type="math/tex; mode=display">
y(T) = y(0)+\underbrace{\int_{t=0}^Tdy(t)}_{\text {sum up all the changes }}</script><h3 id="Wiener-Process"><a href="#Wiener-Process" class="headerlink" title="Wiener Process"></a>Wiener Process</h3><p>维纳过程其实就是布朗运动，对于像粒子这种有可能纯粹随机运动的情况，我们需要引入随机性的方程来描述运动规律，比如下图展示了一个粒子在二维空间中的轨迹：</p>
<p><img src="https://ludwigwinkler.github.io/blog/SDE/BrownianMotion.png" style="zoom: 33%;"></p>
<script type="math/tex; mode=display">
\underbrace{d x_t}_{\text {change in space }}=\overbrace{\epsilon}^{\text {random move }} \underbrace{ d t}_{\text {some change in time }}</script><p>上面的式子描述的一维的简单情况，$dx_t$之间都是独立的，因为对于$\epsilon$的采样是和时间不相关的，因为引入了$\epsilon$这样的随机变量，$x_t$也变成了随机变量，其变化由上面的微分方程描述。</p>
<p>出于简单以及高斯良好的性质(convergence of sequences of random variables, nice theoretical properties)，$\epsilon$ 采样自简单的高斯 $\mathcal N(0,1)$，对于时间变化$dt$，这里选择用$\sqrt[]{dt}$，目的是方便后续方差相关统计量的推导。</p>
<p>下面来分析一下$x_T$这个随机变量，不妨设初始位置$x_0 = 0$：</p>
<script type="math/tex; mode=display">
\begin{aligned}
x_T & =x_0+\int_{t=0}^T d x_t \\
& =\underbrace{x_0}_{=0}+\int_{t=0}^T \epsilon \sqrt{d t} \\
& =\int_{t=0}^T \epsilon \sqrt{d t}
\end{aligned}</script><p>其均值和方差为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
&\begin{aligned}
\mathbb{E}\left[x_T\right] & =\mathbb{E}\left[\int_{t=0}^T d x_t\right] \\
& =\int_{t=0}^T \underbrace{\mathbb{E}[\epsilon]}_{\mathcal{N}(0,1)} \sqrt{d t} \\
& =0
\end{aligned}\\
&\begin{aligned}
\mathbb{V}\left[x_T\right] & =\mathbb{V}\left[\int_{t=0}^T d x_t\right] \\
& =\int_{t=0}^T \underbrace{\mathbb{V}[\epsilon \sqrt{d t}]}_{\mathbb{V}[a X]=a^2 \mathbb{V}[X]} \\
& =\int_{t=0}^T d t \underbrace{\mathbb{V}[\epsilon]}_{\epsilon \sim \mathcal{N}(0,1)} \\
& =\int_{t=0}^T d t \\
& =T
\end{aligned}
\end{aligned}</script><p><img src="https://ludwigwinkler.github.io/blog/SDE/BrownianMotionExperiment.png" style="zoom: 33%;"></p>
<p>为了符号统一，我们将$x_t$用规范的$W_t$来表示，Wiener process主要有三个性质：</p>
<ol>
<li>Independent increments: 高斯的不相关就是独立, $Cov[W_{t+u} - W_s, W_s] = 0$ for $u\geq 0, s \leq t$</li>
<li>Gaussian increments: $W_{t+u} - W_t \sim \mathcal N(0, u) \Leftrightarrow dW_t \sim \mathcal N(0, dt)$</li>
<li>Continuous paths in time: 随着时间的movement是连续的，因此当我们无限放大上面图片中的轨迹，不存在不连续的跳变，这是因为Wiener process是随机过程，也就是不可导的</li>
</ol>
<h3 id="随机微分方程"><a href="#随机微分方程" class="headerlink" title="随机微分方程"></a>随机微分方程</h3><p>了解了微分方程和Wiener process后，一个自然的想法就是结合这两者，而这也正是随机微分方程的定义，Ito drift-diffusion processes定义为：</p>
<script type="math/tex; mode=display">
\underbrace{d X_t}_{\text {total change }}=\underbrace{\mu_t d t}_{\text {deterministic }}+\underbrace{\sigma_t d W_t}_{\text {stochastic }}</script><p><img src="https://ludwigwinkler.github.io/blog/SDE/SDEDriftDiff.png" style="zoom: 33%;"></p>
<p>为了示意方便，下面假设constant mean $\mu$，以及constant diffusion $\sigma$：</p>
<script type="math/tex; mode=display">
\begin{aligned}
X_T & =\int_{t=0}^T d X_t \\
& =\int_{t=0}^T \mu d t+\sigma d W_t \\
& =\mu \int_{t=0}^T d t+\sigma \int_{t=0}^T d W_t \\
& =\mu T+\sigma \int_{t=0}^T d W_t \\
& =\mu T+\sigma W_T
\end{aligned}</script><p>the Brownian motion $W_T \sim \mathcal{N}(0, T)$ is a random variable, which</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathbb{E}\left[X_T\right] & =\mathbb{E}\left[\mu T+\sigma W_T\right] \\
& =\mu T+\sigma \mathbb{E}\left[W_T\right] \\
& =\mu T
\end{aligned}</script><script type="math/tex; mode=display">
\begin{aligned}
\mathbb{V}\left[X_T\right] & =\mathbb{V}\left[\mu T+\sigma W_T\right] \\
& =\underbrace{\mathbb{V}[\mu T]}_{=0}+\mathbb{V}\left[\sigma W_T\right] \\
& =\sigma^2 \mathbb{V}\left[W_T\right] \\
& =\sigma^2 T 

\end{aligned}</script><p>但是实际上一般的SDE的 $\mu$ 和 $\sigma$ 是和 $t$ 以及 $X_t$ 联系的，用于描述他们关系的函数也可能是极为复杂 :p：</p>
<script type="math/tex; mode=display">
d X_t=\mu\left(t, X_t\right) d t+\sigma\left(t, X_t\right) d W_t</script><h3 id="Ito’s-Lemma"><a href="#Ito’s-Lemma" class="headerlink" title="Ito’s Lemma"></a>Ito’s Lemma</h3><p>当前所说的SDE描述的是随机变量间的联系，也就是在值域mapping方面建模，但并没有显式地体现出随机变量的另一个维度，也就是概率分布的角度，当我们感兴趣的是随机变量概率分布的演化过程时，就需要对原本的SDE进行变换，最终得到的方程称为Fokker–Planck equation。</p>
<p>下面我会介绍Fokker–Planck equation是怎么推出的，因为概率分布是随机变量的函数，我们感兴趣的是随机变量函数的演化过程，而描述这样关系的SDE微分规则正是非常著名的伊藤引理(Ito’s Lemma)，假设我们有</p>
<script type="math/tex; mode=display">
dx = \mu(x)dt + \sigma(x)dW</script><p>令$y(t) = f(x(t))$，满足二阶可微，那么则有</p>
<script type="math/tex; mode=display">
d f(x)=\left(\mu(x) f^{\prime}(x)+\frac{1}{2} \sigma^2(x) f^{\prime \prime}(x)\right) d t+\sigma(x) f^{\prime}(x) d W</script><blockquote>
<p>This is an extremely powerful fact because it says that any (twice differentiable) function of a diffusion is also a diffusion</p>
</blockquote>
<h3 id="Fokker–Planck-equation"><a href="#Fokker–Planck-equation" class="headerlink" title="Fokker–Planck equation"></a>Fokker–Planck equation</h3><p>多元函数也是类似的结论，有了Ito’s Lemma这样强大的工具，现在我们知道Fokker–Planck equation其实也应该是个diffusion equation，具体的推导过程如下：</p>
<script type="math/tex; mode=display">
d X_t=\mu\left(t, X_t\right) d t+\sigma\left(t, X_t\right) d W_t</script><p>这里 $W_t$ 是标准布朗运动 (standard Brownian motion)。令 $p(t, x)$ 为 $X_t$ 在 $t$ 时的PDF。固 定 $t_1&lt; t_2$ ，并定义函数 $F(t, x)$ ，使其满足 $F\left(t_1, x\right)=F\left(t_2, x\right)=0$ ，且当 $x \rightarrow \pm \infty$ ， $F(t, x), F_x(t, x) \rightarrow 0$ 。比如，我们可以选择 $f(x)$ ，其满足当 $x \rightarrow \pm \infty$ ， $f(x), f^{\prime}(x) \rightarrow 0$ ，并定义 $F(t, x)=\left(t-t_1\right)\left(t-t_2\right) f(x)$ 。<br>根据伊藤引理 (Ito’s lemma)，我们有</p>
<script type="math/tex; mode=display">
\begin{gathered}
d F\left(t, X_t\right)=F_t d t+F_x d X_t+\frac{1}{2} F_{x x}\left(d X_t\right)^2 \\
=\left(F_t+F_x \mu+\frac{1}{2} F_{x x} \sigma^2\right) d t+F_x \sigma d W_t
\end{gathered}</script><p>等式两边同时取期望，我们有</p>
<script type="math/tex; mode=display">
\begin{gathered}
\mathbb{E}\left[d F\left(t, X_t\right)\right]=\mathbb{E}\left[\left(F_t+F_x \mu+\frac{1}{2} F_{x x} \sigma^2\right) d t\right] \\
=\int_{-\infty}^{\infty}\left(F_t+F_x \mu+\frac{1}{2} F_{x x} \sigma^2\right) p(t, x) d t d x
\end{gathered}</script><p>等式两边同时从 $t_1$ 积分到 $t_2$ ，由于 $F\left(t_1, x\right)=F\left(t_2, x\right)=0$ ，我们有</p>
<script type="math/tex; mode=display">
\begin{aligned}
& 0=\mathbb{E}\left[F\left(t_2, x\right)-F\left(t_1, x\right)\right]=\int_{-\infty}^{\infty} \int_{t_1}^{t_2}\left(F_t+F_x \mu+\frac{1}{2} F_{x x} \sigma^2\right) p(t, x) d t d x=I_1 \\
& +I_2+I_3
\end{aligned}</script><p>通过分部积分 (integration by parts)，并根据 $F\left(t_1, x\right)=F\left(t_2, x\right)=0$ 和Fubini定理，我 们可以得到</p>
<script type="math/tex; mode=display">
\begin{gathered}
I_1=\int_{-\infty}^{\infty} \int_{t_1}^{t_2} \frac{\partial F}{\partial t} p(t, x) d t d x \\
=\int_{-\infty}^{\infty}\left(F\left(t_2, x\right)-F\left(t_1, x\right)-\int_{t_1}^{t_2} F \frac{\partial}{\partial t} p(t, x) d t\right) d x \\
=-\int_{t_1}^{t_2} \int_{-\infty}^{\infty} F \frac{\partial}{\partial t} p(t, x) d x d t
\end{gathered}</script><p>同理，我们计算得到</p>
<script type="math/tex; mode=display">
I_2=-\int_{t_1}^{t_2} \int_{-\infty}^{\infty} F \frac{\partial}{\partial x}(\mu p(t, x)) d x d t</script><p>由于</p>
<script type="math/tex; mode=display">
\begin{gathered}
0=I_1+I_2+I_3=\int_{t_1}^{t_2} \\
\int_{-\infty}^{\infty} F\left[-\frac{\partial}{\partial t} p(t, x)-\frac{\partial}{\partial x} p(t, x)+\frac{\partial^2}{\partial x^2}\left(\frac{1}{2} \sigma^2 p(t, x)\right)\right] d x d t
\end{gathered}</script><p>，且 $F$ 是任意选取的，我们得到</p>
<script type="math/tex; mode=display">
\frac{\partial}{\partial t} p(t, x)=-\frac{\partial}{\partial x}(\mu p(t, x))+\frac{\partial^2}{\partial x^2}\left(\frac{1}{2} \sigma^2 p(t, x)\right)</script><p>这就是一维Fokker-Planck方程, 又叫一维Kolmogorov前向方程。</p>
<p>对于Winner Process其实就是：</p>
<script type="math/tex; mode=display">
\frac{\partial p(x, t)}{\partial t} = \frac{\sigma^2}{2} \frac{\partial^2 p(x, t)}{\partial x^2}</script><p>给定初值条件 $x$ 位于 $x_0$，也就是$p(x, 0) = \delta(x-x_0)$，所得到的解析解为：</p>
<script type="math/tex; mode=display">
p(x, t | x_0, 0) = \frac{1}{\sqrt{2 \pi \sigma^2 t}} \exp\left\{ - \frac{(x - x_0)^2}{2 \sigma^2 t}  \right\}</script><p>下面描述的就是布朗运动的Fokker-Planck方程与实际采样的结果：</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Linear_Potential2.gif" alt="Brownian dynamics simulation for particles in 1-D linear potential compared with the solution of the Fokker–Planck equation" style=" zoom: 80%;"></p>
<p>并不是所有的FPE都有解析解，绝大多数的情况还是没有解的，所以人们会重点研究那些特殊的有解方程，<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Ornstein–Uhlenbeck_process">Ornstein-Uhlenbeck-like processes</a> 就是其中的一类SDE。</p>
<h2 id="Invertible"><a href="#Invertible" class="headerlink" title="Invertible!"></a>Invertible!</h2><h3 id="Special-Case"><a href="#Special-Case" class="headerlink" title="Special Case"></a>Special Case</h3><p>在前向过程中不断添加噪声的过程好比是将一杯咖啡加入牛奶，棕色和白色不断扩散，但是如果是反向从一杯拿铁中分离出一杯牛奶和一杯咖啡，多少有一些违反直觉，但是事实是，对于有些前向扩散的SDE，数学上也会很容易定义一个time reverse process governed by a SDE，我们真的可以模拟这个可逆的过程，因为数学毕竟不是物理现实，通过把时间变量取反，我们是可以做到像林克一样使用倒转乾坤 :p。</p>
<p>直观上来看，diffusion process是粒子不断发散的过程，那么这个逆过程一定就是不断聚合粒子，那么有没有一种SDE满足这样的特性，之前小节提到的OU process其实正是这样的过程：</p>
<blockquote>
<p>this process <em>compresses</em> a Gaussian until it becomes a delta function centered at x0 at time T</p>
</blockquote>
<p>对于最简单的Wiener Process的逆过程，我们可以先利用离散的Euler-Maruyama time steps模拟，其实就是把时间变量取反：</p>
<script type="math/tex; mode=display">
x(t - \Delta t) = x(t) - \frac{x_0 - x}{T - t} \Delta t + \sigma \sqrt{\Delta t} \ \epsilon \ ,t \in [T, 0]</script><p>然后写出对应的SDE：</p>
<script type="math/tex; mode=display">
dx_t = \frac{x_0 - x}{T - t}dt + \sigma \ dW_t</script><p>对应Fokker–Planck equation的解为：</p>
<script type="math/tex; mode=display">
q(x, t | x_0, 0) = \frac{1}{\sqrt{2 \pi \sigma^2 (T - t)}} \exp\left\{ - \frac{(x - x_0)^2}{2 \sigma^2 (T - t)}  \right\}</script><p>为了更直观的理解，我用代码模拟了这个前向和逆向的过程，可以看到逆向最后分布是收敛于delta分布的：</p>
<p><img src="\image\Diffusion_image4.png" alt="Forward" style="zoom: 60%;"><img src="\image\Diffusion_image5.png" alt="Backward" style="zoom: 60%;"></p>
<h3 id="Gerneral-Case"><a href="#Gerneral-Case" class="headerlink" title="Gerneral Case"></a>Gerneral Case</h3><p>对于一般的1D Diffusion来说：</p>
<script type="math/tex; mode=display">
d x=f\left(t, x\right) d t+g\left(t, x\right) d w</script><p>对应的逆过程SDE应该是：</p>
<script type="math/tex; mode=display">
d x = - f(x, T - t)dt + g(T - t)^2 \frac{\partial}{\partial x} \log p(x, T - t)dt + g(T - t) \ dw</script><p>这里给出构造性证明，同一时刻逆向的分布和前向的分布是一致的，可以得到：</p>
<script type="math/tex; mode=display">
q(x, t) = p(x, T - t)</script><p>对于前向过程满足</p>
<script type="math/tex; mode=display">
\frac{\partial p(x, t)}{\partial t} = - \frac{\partial}{\partial x} \left[ \  f(x, t) p(x, t) \ \right] + \frac{\partial^2}{\partial x^2} \left[ \ \frac{g(x, t)^2}{2} p(x, t) \ \right]</script><p>把时间逆转， $p(x, T - t)$ 满足</p>
<script type="math/tex; mode=display">
\frac{\partial p(x, T - t)}{\partial t} = \frac{\partial}{\partial x} \left[ \  f(x, T-t) p(x, T-t) \ \right] - \frac{\partial^2}{\partial x^2} \left[ \ \frac{g(x, T-t)^2}{2} p(x, T-t) \ \right]</script><p>由于 $q(x, t) = p(x, T - t)$ ，因此 $q(x, t)$ 是如下Fokker–Planck equation的解</p>
<script type="math/tex; mode=display">
\frac{\partial q(x, t)}{\partial t} = - \frac{\partial}{\partial x} \left[ \  \left( f(x, T-t) - g(T-t)^2 \frac{\partial}{\partial x} \log p(x, T-t) \right)  q(x, t) \ \right] + \frac{\partial^2}{\partial x^2} \left[ \ \frac{g(x, T-t)^2}{2} q(x, t) \ \right]</script><p>因此我们构造出了逆过程的SDE，推广到 $N$-dimension，SDE的形式是：</p>
<script type="math/tex; mode=display">
d{\mathbf{x}} = - \mathbf{f}(\mathbf{x}, T - t)dt + g(T - t)^2 \ \nabla_{\mathbf{x}} \log p(\mathbf{x}, T - t)dt + g(T - t)d\mathbf w</script><p>将$T-t$换元，可以得到：</p>
<script type="math/tex; mode=display">
d{\mathbf{x}} = \mathbf{f}(\mathbf{x}, t)dt - g(t)^2 \ \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)dt + g(t)d\mathbf w</script><h3 id="Magical-way-to-generate-samples"><a href="#Magical-way-to-generate-samples" class="headerlink" title="Magical way to generate samples"></a>Magical way to generate samples</h3><p>不知道在看到了SDE这可以用magical来形容的结果后，你是否和我一样感到兴奋无比，因为这的确提供了一种关于生成过程的新思路，如果拥有超乎寻常的洞察力，以及对于热力学夯实的数学功底，重返2015年，说不定真的可以自己提出Diffusion模型:p，这里我会拿Diffusion作者最初的motivation举例，希望能提供给你一些insights。</p>
<p>当你看到一滴墨水在水中扩散时，你会想到什么，如果给你一张全是noise的图片，你又能发掘出什么。原作者就在墨水扩散的过程中看到了sde的可逆性，并且如果把时间尺度缩小，粒子在微小时间间隔内的forward和backward其实都可以视为布朗运动，对应高斯的diffusion，作者曾经花了大把时间看一副全是noise的图片，从中看到了各种物体，这其实也就是denoise的思想。</p>
<p>让我们反思2015年前的模型，主要分为GAN和VAE两类，基于变分架构的VAE对后验分布$q_\phi(z|x)$很难选择，后续的改进工作很多都是针对这个后验，比如引入normalizing flow来提升变分后验的表达能力，但是GAN和normalizing flow，其实都只是针对生成器建模，这点来说要比VAE更加直接，但是相应的他们也有自己的问题，比如GAN要训练判别器收敛难，normalizing flow的限制太强，表达能力不够，针对于这些问题，我们能否设计出一个新的生成架构，也就是只对生成器建模，不需要后验或者判别器额外建模，也具有强大的表达能力。</p>
<p>而Diffusion就是这样的模型，既然先定义了生成器$p_\theta(x|z)$再去找对应的后验很困难，不如我们先定义后验，再去适配生成器，这样就能避免优化变分后验，而是直接优化生成器，通过前向扩散为生成过程大致指定了路径，从而大大减小了生成器的搜索空间。</p>
<h2 id="Score-based"><a href="#Score-based" class="headerlink" title="Score based"></a>Score based</h2><p>上一小节最后得到的逆SDE中有一个看起来很有趣的函数，这其实就是<strong>score function</strong>了:p</p>
<script type="math/tex; mode=display">
\mathbf{s}(\mathbf{x}, t) := \nabla_{\mathbf{x}} \ p(\mathbf{x}, t)</script><p>如果我们想要从一堆杂乱无章的噪声中通过逆向SDE得到我们目标的分布，我们需要知道score function的形式，而这也正是一个chicken and egg problem：</p>
<blockquote>
<p>Why is this difficult? <em>We don’t know p(x,t)!</em> If we did, we could just sample from it directly instead of doing reverse diffusion.</p>
</blockquote>
<p>虽然本质上我们需要 $p(\mathbf{x},t)$ 的信息，但是从score function的角度出发，相比直接去学习$p(\mathbf x, t)$要更加容易，因为我们并不需要约束概率分布的normalization factor。</p>
<script type="math/tex; mode=display">
\begin{aligned}
\nabla_{\boldsymbol{x}} \log p_{\boldsymbol{\theta}}(\boldsymbol{x}) & =\nabla_{\boldsymbol{x}} \log \left(\frac{1}{Z_{\boldsymbol{\theta}}} e^{-f_{\boldsymbol{\theta}}(\boldsymbol{x})}\right) \\
& =\nabla_{\boldsymbol{x}} \log \frac{1}{Z_{\boldsymbol{\theta}}}+\nabla_{\boldsymbol{x}} \log e^{-f_{\boldsymbol{\theta}}(\boldsymbol{x})} \\
& =-\nabla_{\boldsymbol{x}} f_{\boldsymbol{\theta}}(\boldsymbol{x}) \\
& \approx \boldsymbol{s}_{\boldsymbol{\theta}}(\boldsymbol{x})
\end{aligned}</script><p>举个栗子，对于Wiener Process，对应的score function为：</p>
<script type="math/tex; mode=display">
p(x, t) = \frac{1}{\sqrt{2 \pi \sigma^2 t}} \exp\left\{ - \frac{(x - x_0)^2}{2 \sigma^2 t}  \right\} \\

s(x, t) = \frac{\partial}{\partial x} \log p(x, t) = - \frac{(x - x_0)}{\sigma^2 t}</script><h3 id="Langevin-dynamics"><a href="#Langevin-dynamics" class="headerlink" title="Langevin dynamics"></a>Langevin dynamics</h3><p>当我们学习到了score function的参数化表示，让我们考虑如何从目标分布中采样，一个自然的想法其实是按照inverse SDE逐步得到原样本，我们需要自己来设计这个inverse SDE，这个思路留到后面的章节介绍。</p>
<p>这节主要介绍一种基于score function采样本身就有着一种来源于物理学背景时代悠久的方法，称之为郎之万dynamics，但值得注意的是这并不是一种特殊的inverse SDE，而只是一种score based MCMC。郎之万dynamics这个方法本身因为并没有考虑到图像生成的一些问题，是需要我们进一步优化的，而且后面我们可以利用reverse sde以及<strong>probability flow ODE</strong>来替代这种采样的过程。但作为一种初步的尝试却是十分合适的选择，也能揭露出问题的一些本质。</p>
<p>郎之万方程的物理背景其实就是描述受随机力影响的布朗运动系统的演变过程，有兴趣可以自己去看看，推导也是很简单，具体的形式如下图所示，$V(x)$ 表示potential energy：</p>
<script type="math/tex; mode=display">
d x= -\nabla V(x) d t+\sqrt{2} \sigma d W</script><p>根据Fokker-Planck equation，可以写出对应的概率分布sde：</p>
<script type="math/tex; mode=display">
\frac{\partial}{\partial t} q(x, t)=\frac{\partial}{\partial x}[\nabla V(x) q(x, t)]+\frac{\partial^2}{\partial x^2}\left[\sigma^2 q(x, t)\right]</script><p>如果想要我们感兴趣的分布$q$最后收敛，应该满足：</p>
<script type="math/tex; mode=display">
\frac{\partial}{\partial t} q_{\infty}(x)=\frac{\partial}{\partial x}\left[\nabla V(x) q_{\infty}(x)+\frac{\partial}{\partial x}\left[\sigma^2 q_{\infty}(x)\right]\right]=\frac{\partial}{\partial x} J=0</script><p>也就是$t\to \infty$：</p>
<script type="math/tex; mode=display">
\frac{\partial}{\partial t} q_{\infty}(x)= -{\nabla V(x) \over \sigma^2}  q_{\infty}(x)</script><p>得到：</p>
<script type="math/tex; mode=display">
q_∞(x)∝exp(−{V(x) \over σ^2})</script><p>也就是说如果我们想要把最后的平稳分布当成目标分布$q(x)$采样，就要把势能函数$V(x)$设置为：</p>
<script type="math/tex; mode=display">
V(x) = -\log (p(x))</script><p>这样也就得到了Langevin dynamics：</p>
<script type="math/tex; mode=display">
d x=\nabla \log p(x) d t+\sqrt{2} \sigma d W</script><p>利用Euler-Maruyama method离散化，可以得到：</p>
<script type="math/tex; mode=display">
x_{n+1}=x_n + \nabla \log p(x) \epsilon + \sigma\sqrt{2\epsilon}\ z \\
\epsilon \to time\ step\ , \ z\sim \mathcal N(0,1)</script><p>下面是对于使用 Euler-Maruyama 方法近似的具有零均值和单位方差的高斯分布随时间演变的示例：</p>
<p><img src="https://perceptron.blog/assets/images/langevinsampling.gif" style="zoom: 50%;"></p>
<h3 id="Naive-Objective-function"><a href="#Naive-Objective-function" class="headerlink" title="Naive Objective function"></a>Naive Objective function</h3><p>假设我们已经有了score function的参数化表示 $\mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t)$，我们想要在 $\mathbf{x}$ ，$t$ 上这个值域上近似目标score function，所以很容易写出一个简单的形式： </p>
<script type="math/tex; mode=display">
J(\boldsymbol{\theta}) \stackrel{?}{:=} \frac{1}{2} \int d\mathbf{x} dt \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)  \right]^2</script><p>因为最终是靠sample的样本计算损失，所以不能view all sample as the same，我们需要根据 $\mathbf{x}$ 的分布来计算损失，也就是求期望：</p>
<script type="math/tex; mode=display">
J(\boldsymbol{\theta}) \stackrel{?}{:=} \frac{1}{2} \int d\mathbf{x} dt \ p(\mathbf{x}, t) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)  \right]^2</script><p>对于$\mathbf{x}$，我们通过分布采样的思想确定了哪些value是更容易出现的，因此对于loss的contribute要更大，对于$t$，我们也需要考虑加上一个weighting factor指出哪些时刻是有些不同的，作用就是引入先验知识，更方便训练，最终我们得到了一个初步完善的objective function：</p>
<script type="math/tex; mode=display">
J_{naive}(\boldsymbol{\theta}) := \frac{1}{2} \int d\mathbf{x} dt \ \lambda(t) \  p(\mathbf{x}, t) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)  \right]^2</script><p>然而分布$p(\mathbf x, t)$还是依赖于初始时刻的目标分布的，也就是$p(\mathbf x, 0)$，这也让求解变得棘手了起来，其他学者早已研究出如何在不知道真值的情况进行优化，这类方法统称为“score matching”，通过分布积分可以化简得到：</p>
<script type="math/tex; mode=display">
\begin{aligned}
& \sum_{t=1}^T \lambda(t)\mathbb{E}_{p_{\mathrm{data}}(\mathrm{x})}\left[\frac{1}{2}\left\|s_\theta(\mathrm{x})\right\|_2^2+\operatorname{trace}(\underbrace{\nabla_{\mathrm{x}} s_\theta(\mathrm{x})}_{\text {Jacobian of } s_\theta(\mathrm{x})})\right] \\
\approx & \frac{1}{N} \sum_{t=1}^T \lambda(t)\sum_{i=1}^N\left[\frac{1}{2}\left\|s_\theta\left(\mathbf{x}_i\right)\right\|_2^2+\operatorname{trace}\left(\nabla_{\mathrm{x}} s_\theta\left(\mathbf{x}_i\right)\right)\right]
\end{aligned}</script><p>但是由于Jacobian通常会很大，计算代价过高，解决的方法是可以采用<strong>sliced score matching</strong>这个策略，通过random projection 得到random one-dimensional scalar fieilds来近似，简化计算量也同时保证了良好的统计性质。</p>
<h3 id="Improve-Langevin-Dynamics"><a href="#Improve-Langevin-Dynamics" class="headerlink" title="Improve Langevin Dynamics"></a>Improve Langevin Dynamics</h3><p>解决了训练问题，就可以用之前介绍的郎之万采样得到新的样本了：</p>
<p><img src="https://yang-song.net/assets/img/score/smld.jpg" style="zoom: 20%;"></p>
<p>但是这也做实际的效果很差，loss 不断震荡，原因是：</p>
<ol>
<li>低密度区域的样本太少，估计就会不准确，甚至某些采样点的概率可能为0，那么取对数就没有意义。</li>
<li><strong>生活中的真实数据大部分都倾向于分布在低维空间中</strong>，这也是大名鼎鼎的 <strong>“流形学习”(mainfold learning)</strong> 的大前提。也就是说，我们的编码空间(通过神经网络等一系列方法)的维度可能很广泛，但是数据经过编码后在许多维度上都存在冗余，实际上用一部分维度就足以表示它，说明<strong>实质上它仅分布在整个编码空间中的一部分(低维流形)，并没有“占满”整个编码空间</strong>。<strong>分数这个东西：</strong>$\frac{\partial log(p_{data}(x))}{\partial x}$ <strong>，是针对整个编码空间定义的</strong>，然而当我们的数据仅分布在编码空间的低维流形时，分数就会出现“没有定义” (undefined) 的情况。<strong>score matching 的训练目标是基于数据“占满”了整个编码空间这个前提下而推出来的</strong>。当数据仅分布在低维流形中时，score matching 的方法就不适用了，因为undefined区域的score不能提供任何有用的信息。</li>
<li>朗之万动力学无法正确衡量不同mode的权重</li>
</ol>
<p><img src="\image\Diffusion_image8.png" alt="image-20230704114313576" style="zoom:80%;"></p>
<p>所以一个自然的想法就是对原数据分布进行扰动，加入高斯噪声，就减少了零概率的出现，使得低密度区域也有了更多的样本。<strong>高斯噪声是分布在整个编码空间的，因此，扰动后的数据就不会仅“驻扎”在低维流形</strong>，而是能够有机会出现在整个编码空间的任意部分，从而避免了分数(score)没有定义(undefined)的情况，同时使得 score matching适用，这就破解了“loss 不收敛”的困局。这里还有一点mode-seeking转成mode-covering的味道。</p>
<p><img src="\image\Diffusion_image9.png" alt="image-20230704121124581" style="zoom: 50%;"></p>
<p>而这里如何确定噪声的大小就成了问题的关键，目前提出的是加一系列不同尺度的噪声，然后分步训练每一尺度的score matching网络，具体过程是先引入一系列噪声${\sigma<em>t}^T</em>{t=1}:\sigma_1 &lt; \sigma_2 &lt; \cdots &lt; \sigma_L$，$\mathcal{N}(0, \sigma_i^2 I), i=1,2,\cdots,L$，这里选取noise的原则是：</p>
<ol>
<li>Maximum noise scale: $\sigma_L$ 应该取为数据点间的最大距离</li>
<li>Minimum noise scale: $\sigma_0$ 应足够小以控制最终样品中的噪声</li>
<li>相邻噪声尺度应有足够的重叠，以促进退火朗之万dynamic中噪声尺度的过渡。</li>
</ol>
<p><img src="\image\Diffusion_image16.png" alt="image-20230704122223514" style="zoom: 50%;"></p>
<p>一种尝试就是让$\sigma$之间满足几何级数的关系${\sigma<em>1 \over \sigma_2} =…={\sigma</em>{L-1} \over \sigma_L} &lt; 1$，然后就可以得到对应的噪声扰动后的分布：</p>
<script type="math/tex; mode=display">
p_{\sigma_i}(\mathbf{x}) = \int p_{data}(t) \mathcal{N}(\mathbf{x}; t, \sigma_i^2 I) \mathrm{d} t.</script><blockquote>
<p>如果随机变量满足 $Y = aX + \mathcal N (0, \sigma^2)$，那么$P(y|x) = \mathcal N(aX, \sigma^2)$，这也很好理解，条件概率相当于fix了$X$，然后对应只有高斯的变化</p>
</blockquote>
<p>这里用一个原图来帮助理解，我们要训练的是图中的箭头 (大小和方向)，随着 $\sigma_1&lt;\sigma_2&lt;\sigma_3$ 增大，学到的箭头越来越细腻，对应的郎之万采样称为<strong>Annealed Langevin Dynamics</strong>。</p>
<p><img src="https://yang-song.net/assets/img/score/ald.gif" style="zoom: 80%;"></p>
<p><img src="https://ammunk.com/assets/img/ncsn/figs/algorithm.png" style="zoom: 33%;"></p>
<blockquote>
<p>注意这里是noise sequence其实是反过来的</p>
</blockquote>
<p>退火郎之万方程的motivation其实就是就是<strong>固定 “信噪比”(signal-to-noise)</strong> 的量级：</p>
<script type="math/tex; mode=display">
\tilde{x}_t \leftarrow \tilde{x}_{t-1} + \frac{\alpha_i}{2}s_\theta(\tilde{x}_{t-1},\sigma_i)+ \sqrt{\alpha_i}z_t</script><p>就是式子中的$\alpha<em>is</em>\theta(x, \sigma_i)\over 2\sqrt{\alpha_i}z_t$：</p>
<script type="math/tex; mode=display">
E\left\|\frac{\alpha_i s_\theta\left(x, \sigma_i\right)}{2 \sqrt{\alpha_i} z}\right\|_2^2 \approx E\left[\frac{\alpha_i\left\|s_\theta\left(x, \sigma_i\right)\right\|_2^2}{4 z^2}\right] \asymp \frac{1}{4} E\left[\left\|\sigma_i s_\theta\left(x, \sigma_i\right)\right\|_2^2\right](x)</script><p>作者凭他的经验性结果告诉过我们一个结论： $s<em>\theta\left(x, \sigma_i\right) \asymp \frac{1}{\sigma_i}$ ，于是这里就有 $\sigma_i s</em>\theta\left(x, \sigma<em>i\right) \asymp 1$ 。结合式 $(x)$ ，我们得到 $\frac{1}{4} E\left[\left|\sigma_i s</em>\theta\left(x, \sigma_i\right)\right|_2^2\right] \asymp \frac{1}{4}$ 。这就说明，在 $\alpha_i \asymp \sigma_i^2$ 的设置下，信噪比会固定在常量级，与噪声级别 $\sigma_i$ 无关。</p>
<p>现在来看之前我们推的目标函数：</p>
<script type="math/tex; mode=display">
J_{naive}(\boldsymbol{\theta}) := \frac{1}{2} \int d\mathbf{x} dt \ \lambda(t) \  p(\mathbf{x}, t) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)  \right]^2</script><p>其中$\lambda(t)$是一个关于$t$的权重向量，可以引入inductive bias，也就是实现了前面说的分不同噪声尺度训练。在这种设定下，朗之万动力学采样也是分尺度来做，只不过是逆着来，从 $t=T$ 到 $t=T-1$，最后到 $t=1$。直觉上高噪声提供了低密度区域较好的引导，低噪声提供了高密度区域较好的引导，这样使得整个采样过程更加稳定。这个过程就称之为<strong>denoising score matching</strong> 。</p>
<h3 id="Final-Objective-function"><a href="#Final-Objective-function" class="headerlink" title="Final Objective function"></a>Final Objective function</h3><p>虽然不能直接得到目标分布的信息，但是我们可以通过条件概率引入噪声间接获取关于目标函数分布的关系，最终达到相同的gloable minim，让我们推出最终的Denoising score matching Loss Function：</p>
<script type="math/tex; mode=display">
J_{DSM}(\boldsymbol{\theta}) := \frac{1}{2} \int d\mathbf{x} d\mathbf{x}^{(0)} dt \ p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) p(\mathbf{x}^{(0)}) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0)  \right]^2 \\
= \frac{1}{2} \mathbb{E}_t\left\{  \ \lambda(t) \ \mathbb{E}_{\mathbf{x}^{(0)}} \mathbb{E}_{\mathbf{x} | \mathbf{x}^{(0)}} \left[ \ \Vert \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) \  \Vert^2_2 \ \right] \ \right\}</script><blockquote>
<p>需要特别说明的是，随时间的期望是根据 [0,T] 上的均匀分布得出的。</p>
</blockquote>
<script type="math/tex; mode=display">
\begin{split}
\nabla_{\boldsymbol{\theta}} J_{ESM}(\boldsymbol{\theta}) &= \int d\mathbf{x} dt \ p(\mathbf{x}, t) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t)  \\
&=  \int d\mathbf{x} dt \ p(\mathbf{x}, t) \ \left[ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \frac{\nabla_{\mathbf{x}} p(\mathbf{x}, t)}{p(\mathbf{x}, t)}  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) \\
&=  \int d\mathbf{x} dt \ \left[ \ p(\mathbf{x}, t) \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} p(\mathbf{x}, t) \  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) \\
&=  \int d\mathbf{x} d\mathbf{x}^{(0)} dt \ \left[ \ p(\mathbf{x}, t , \mathbf{x}^{(0)}, 0) \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} p(\mathbf{x}, t , \mathbf{x}^{(0)}, 0) \  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) \\
&=  \int d\mathbf{x} d\mathbf{x}^{(0)} dt \ p(\mathbf{x}^{(0)}) \ \left[ \ p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) \  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) \\
&=  \int d\mathbf{x} d\mathbf{x}^{(0)} dt \ p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) p(\mathbf{x}^{(0)}) \ \left[ \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) \  \right] \cdot \nabla_{\boldsymbol{\theta}} \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) \\
& = \nabla_{\boldsymbol{\theta}} J_{DSM}(\boldsymbol{\theta})
\end{split}</script><script type="math/tex; mode=display">
J_{ESM}(\boldsymbol{\theta}) = J_{DSM}(\boldsymbol{\theta}) + C</script><p>此外，还有和KL div的联系，$\pi$表示逆向初始采样的分布：</p>
<script type="math/tex; mode=display">
\begin{array}{r}
\mathrm{KL}\left(p_0(\mathbf{x}) \| p_\theta(\mathbf{x})\right) \leq \frac{T}{2} \mathbb{E}_{t \in \mathcal{U}(0, T)} \mathbb{E}_{p_t(\mathbf{x})}\left[\lambda(t)\left\|\nabla_{\mathbf{x}} \log p_t(\mathbf{x})-\mathbf{s}_\theta(\mathbf{x}, t)\right\|_2^2\right] 
+\mathrm{KL}\left(p_T \| \pi\right)
\end{array}</script><p>下面我会介绍利用采样的样本计算目标函数值的流程，给定一个来自目标分布的样本$\mathbf x^{(0)}$:</p>
<ol>
<li>从$[0, T]$ 均匀分布采样 $t$</li>
<li>利用我们已有的转移概率信息去采样 $\mathbf{x} \sim p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0)$</li>
<li>利用已有的转移概率信息去计算 $\nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0)$</li>
</ol>
<p>这样我们就得到了近似：</p>
<script type="math/tex; mode=display">
J(\boldsymbol{\theta}) \approx \frac{1}{2} \lambda(t) \left[ \ \mathbf{s}_{\boldsymbol{\theta}}(\mathbf{x}, t) - \nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0)  \ \right]^2</script><p>因为通常我们把转移概率定义为和指数相关的简单分布，所以实际上score function value还是很容易计算的，对于之前的Wiener Process来说，我们有:</p>
<script type="math/tex; mode=display">
\begin{split}
p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) &= \frac{1}{\left[ \sqrt{2 \pi \sigma^2(t)} \right]^N} \exp\left\{ - \frac{\left[ \mathbf{x} - \mathbf{x}^{(0)} \right]^2}{2 \sigma^2(t)}  \right\} \ ,
\end{split}</script><script type="math/tex; mode=display">
\nabla_{\mathbf{x}} \log p(\mathbf{x}, t | \mathbf{x}^{(0)}, 0) = - \frac{\left[ \mathbf{x} - \mathbf{x}^{(0)} \right]}{\sigma^2(t)}</script><h3 id="Combine-SDE-with-Score"><a href="#Combine-SDE-with-Score" class="headerlink" title="Combine SDE with Score"></a>Combine SDE with Score</h3><p>到目前为止其实主要介绍了score based的一些method，但是这些方法并没有和SDE建立本质的联系，也就是并没有强调对于前向和逆向SDE建模，只是用了MCMC采样这样的策略，接下来我会介绍如何从SDE的视角结合score进行建模。</p>
<p>对于<strong>SDE的设计</strong>，通常都是<strong>hand designed</strong>，songyang给出了几种常用的SDE：the Variance Exploding SDE (VE SDE), the Variance Preserving SDE (VP SDE), and the sub-VP SDE，对于<strong>解reverse SDE</strong>，最简单的想法就是利用Euler-Maruyama method，也就是离散的SDE去迭代，虽然郎之万不满足reverse SDE的形式，但是它和Euler-Maruyama reverse SDE都是利用score function去迭代，这是它们的相似之处，除了Euler-Maruyama method，解reverse SDE数值方法还有Milstein method, and stochastic Runge-Kutta methods。</p>
<p>考虑到我们只关心的是 $p_t(x)$，在不同时间步长获得的样本可以具有任意相关性，并且不必形成从反向 SDE 采样的特定轨迹。我们可以应用 MCMC 方法来微调从数值 SDE 求解器获得的轨迹。 具体来说，songyang提出预测-校正采样器。 预测器可以是任何能够从现有样本$\mathbf x(t) \sim p_t(x)$ 预测$\mathbf x(t+\Delta t) \sim p_t(x + \Delta t)$的SDE 求解器 ， 校正器可以是任何仅依赖于得分函数的 MCMC procedure ，例如 Langevin dynamics。</p>
<p><img src="\image\Diffusion_image13.png" alt="image-20230705141006079" style="zoom: 55%;"></p>
<h3 id="Probability-flow-ODE"><a href="#Probability-flow-ODE" class="headerlink" title="Probability flow ODE"></a>Probability flow ODE</h3><p>ODE其实就是把SDE中的stochastic diffusion项去除，只留drift coefficient项：</p>
<script type="math/tex; mode=display">
d{\mathbf{x}} = \mathbf{f}(\mathbf{x}, t)dt - g(t)^2 \ \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)dt</script><p>songyang在<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2011.13456.pdf">paper</a>附录D中给出了<strong>每个扩散过程都有对应的确定性ODE的形式使得其边缘分布${p<em>t(x)}</em>{t\in [0,T]}$与SDE一致</strong>的证明，以下是其一般形式（注意其和SDE形式的高度相似，如score function的系数不同，删去了噪音项）</p>
<script type="math/tex; mode=display">
d{\mathbf{x}} = \mathbf{f}(\mathbf{x}, t)dt - {1\over 2}g(t)^2 \ \nabla_{\mathbf{x}} \log p(\mathbf{x}, t)dt</script><p>这是因为概率流 ODE 提供了从噪声分布到数据分布的确定性映射，反之亦然。 这样做，我们基本上可以摆脱朗之万动力学采样，并用概率流 ODE 完全取代它，不难看出，我们可以把概率流 ODE视为一类continuous normalizing flow。</p>
<p>下图描述了 SDE 和概率流 ODE 的轨迹。 尽管 ODE 轨迹明显比 SDE 轨迹更平滑，但它们将相同的数据分布转换为相同的先验分布，反之亦然，通过求解概率流 ODE 获得的轨迹与 SDE 轨迹具有相同的边际分布${p<em>t(x)}</em>{t\in [0,T]}$。</p>
<p><img src="\image\Diffusion_image14.png" alt="image-20230705141101171" style="zoom:67%;"></p>
<p>尽管能够生成高质量样本，但基于 Langevin MCMC 和 SDE 求解器的采样器无法提供计算基于分数的生成模型的精确对数似然的方法，而只能计算ELBO。 而基于ODE的采样器却可以进行精确的似然计算，也就是说diffusion model同时可以定义一个概率流 ODE，它可以被用来做密度估计和似然计算（原因可以去看大名鼎鼎的Neural ODE，这个是关于深度学习本质的理论，这里就不多介绍）。</p>
<h3 id="Special-Case-GMM"><a href="#Special-Case-GMM" class="headerlink" title="Special Case GMM"></a>Special Case GMM</h3><p>接下来我会以GMM举例，介绍如何利用DSM(Denoising score matching)，来做到拟合分布，这兼顾了Simplicity和Expressivity两方面特性：</p>
<p><strong>Simplicity</strong></p>
<ul>
<li>概率密度和score function方便计算</li>
<li>在Diffusion过程中，GMM还是维持GMM形式的概率分布</li>
</ul>
<p><strong>Expressivity</strong></p>
<ul>
<li>GMM是可以拟合一切分布的 <a target="_blank" rel="noopener" href="https://stats.stackexchange.com/questions/446351/the-approximation-power-of-gaussian-mixture-models">this post</a></li>
</ul>
<p>GMM的一般形式为：</p>
<script type="math/tex; mode=display">
p(x)=\sum_i^k\pi_i f(x;\mu_i,\Sigma_i) \\
f(x;\mu,\Sigma)=((2\pi)^n\det\Sigma)^{-1/2}\exp(-\frac12(x-\mu)^T\Sigma^{-1}(x-\mu))</script><p>Score Function的形式可以直接写出来的（但是对于图像生成问题，不知道目标分布形式，就没法得到这步，这里为了演示目的，故意选择GMM的），我会选择用一个简单的神经网络来预测这个score function：</p>
<script type="math/tex; mode=display">
\nabla_x \log p(x)=\frac{\sum_i\pi_i \nabla_x f_i(x)}{\sum_i\pi_i f_i(x)}\\
=-\frac{\sum_i\pi_i f_i(x)\Sigma_i^{-1}(x-\mu_i)}{\sum_i\pi_i f_i(x)}\\
=\sum_i w_i\nabla \log f_i(x)
\\ w_i=\frac{\pi_i f_i(x)}{\sum_j\pi_j f_j(x)}=\frac{p(x|z=i)p(z=i)}{p(x)}=p(z=i|x)</script><p>这个例子是我们先设计一个forward的diffusion过程，不断加noise，然后用已有的数据训练预测score function，根据reverse sde去得到denoise的目标分布。下面随机生成了一个GMM，并对于数据进行了可视化，并作为后续例子的目标分布：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mu1 = np.array([<span class="number">0</span>,<span class="number">1.0</span>])</span><br><span class="line">Cov1 = np.array([[<span class="number">1.0</span>,<span class="number">0.0</span>],</span><br><span class="line">          [<span class="number">0.0</span>,<span class="number">1.0</span>]])</span><br><span class="line">mu2 = np.array([<span class="number">2.0</span>,-<span class="number">1.0</span>])</span><br><span class="line">Cov2 = np.array([[<span class="number">2.0</span>,<span class="number">0.5</span>],</span><br><span class="line">          [<span class="number">0.5</span>,<span class="number">1.0</span>]])</span><br></pre></td></tr></tbody></table></figure>
<p><img src="\image\Diffusion_image2.png" style="zoom: 60%;"><img src="\image\Diffusion_image3.png" style="zoom: 60%;"><img src="\image\Diffusion_image1.png" style="zoom: 60%;"></p>
<p>前向过程，我们设计如下的diffusion sde，其实增加noise perturbation的方法有很多种，这里选取的是类似于之前perturbing data with$\mathcal{N}(0, \sigma_1^2 I), \mathcal{N}(0, \sigma_2^2 I), \cdots, \mathcal{N}(0, \sigma_L^2 I)$：</p>
<script type="math/tex; mode=display">
d \mathbf{x} = \sigma^t d\mathbf{w}, \quad t\in[0,1]</script><p>对应的离散形式就是Markov process：</p>
<script type="math/tex; mode=display">
\mathbf{x_{t+\Delta t}} = \mathbf{x_{t}}+\sigma^t \sqrt{\Delta t} z_t \\
p(\mathbf x_t=\mathbf{x}|\mathbf x_0)=\mathcal{N}\bigg(\mathbf{x}; \mathbf x_0, \frac{\sigma^{2t} - 1}{2 \log \sigma}\mathbf{I}\bigg)</script><p>最终的分布会趋近于$GMM\sim{\pi_i,\mu_i,\Sigma_i^{(t)}}$：</p>
<script type="math/tex; mode=display">
\Sigma_i^{(t)}=\Sigma_i+\frac{\sigma^{2t} - 1}{2 \log \sigma}I</script><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">x0, _, _ = gmm.sample(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">sigma = <span class="number">5</span></span><br><span class="line">nsteps = <span class="number">200</span></span><br><span class="line"></span><br><span class="line">x_traj = np.zeros((*x0.shape, nsteps, ))</span><br><span class="line">x_traj[:,:,<span class="number">0</span>] = x0</span><br><span class="line">dt = <span class="number">1</span> / nsteps</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, nsteps):</span><br><span class="line">  t = i * dt</span><br><span class="line">  eps_z = np.random.randn(*x0.shape)</span><br><span class="line">  x_traj[:,:,i] = x_traj[:,:,i-<span class="number">1</span>] + eps_z * (sigma ** t) * np.sqrt(dt)</span><br></pre></td></tr></tbody></table></figure>
<p><img src="\image\Diffusion_image11.png" style="zoom: 67%;"></p>
<p>对应的逆向sde是：</p>
<script type="math/tex; mode=display">
\begin{align}

d\mathbf{x} = -\sigma^{2t} \nabla_\mathbf{x} \log p_t(\mathbf{x}) dt + \sigma^t d \bar{\mathbf{w}}.

\end{align}</script><p>离散的马尔科夫链版本是：</p>
<script type="math/tex; mode=display">
\mathbf{x}_{t-\Delta t} = \mathbf{x}_t + \sigma^{2t} s_\theta(\mathbf{x}_t, t)\Delta t + \sigma^t\sqrt{\Delta t} \mathbf{z}_t,
\\
\mathbf{z}_t \sim \mathcal{N}(\mathbf{0}, \mathbf{I})</script><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sampN = <span class="number">1000</span></span><br><span class="line">sigma = <span class="number">5</span></span><br><span class="line">nsteps = <span class="number">400</span></span><br><span class="line"></span><br><span class="line">lambdaT = (sigma**<span class="number">2</span> - <span class="number">1</span>) / (<span class="number">2</span> * np.log(sigma)) <span class="comment"># marginal_prob_std_np(1.0, sigma)</span></span><br><span class="line">xT = np.sqrt(lambdaT) * np.random.randn(sampN, <span class="number">2</span>)</span><br><span class="line">x_traj_rev = np.zeros((*x0.shape, nsteps, ))</span><br><span class="line">x_traj_rev[:,:,<span class="number">0</span>] = xT</span><br><span class="line">dt = <span class="number">1</span> / nsteps</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, nsteps):</span><br><span class="line">  t = (nsteps - i) * dt <span class="comment"># note the time fly back</span></span><br><span class="line">  <span class="comment"># transport the gmm to that at time $t$ and compute score at that time $\nabla \log p_t(x)$ </span></span><br><span class="line">  gmm_t = diffuse_gmm(gmm, t, sigma) <span class="comment"># note the time fly back! start from the largest noise scale</span></span><br><span class="line">  score_xt = gmm_t.score(x_traj_rev[:,:,i-<span class="number">1</span>])</span><br><span class="line">  eps_z = np.random.randn(*x0.shape)</span><br><span class="line">  x_traj_rev[:,:,i] = x_traj_rev[:,:,i-<span class="number">1</span>] + eps_z * (sigma ** t) * np.sqrt(dt) + score_xt * dt * sigma**(<span class="number">2</span>*t)</span><br></pre></td></tr></tbody></table></figure>
<p><img src="\image\Diffusion_image12.png" style="zoom: 67%;"></p>
<p>依赖时间的score function定义为 $s(x,t):\mathbb R^2\times [0,1]\to\mathbb R^2,(x,t)\mapsto \nabla_x \log p_t(x)$，我们可以用一个简单的神经网络来训练，对于时间我们需要进行特殊的编码，这里方法有很多，比如GaussianFourierProjection，然后把编码后的特征送到MLP里面就行了。</p>
<p>现在来看目标函数：</p>
<script type="math/tex; mode=display">
J_{DSM}(\theta)=\mathbb E_{\tilde x,x\sim p_\sigma(\tilde x,x)}\frac 12\|s_\theta(\tilde x)-\nabla_\tilde x\log p_\sigma(\tilde x\mid x)\|^2\\
J_{ESM}(\theta)=\mathbb E_{\tilde x\sim p_\sigma(\tilde x)}\frac 12\|s_\theta(\tilde x)-\nabla_\tilde x\log p_\sigma(\tilde x)\|^2</script><p>带入$p_t(\tilde x\mid x)= \mathcal N(x,\beta^2_t I)$, then $\tilde x=x+\beta_t z,z\sim \mathcal N(0,I)$：</p>
<script type="math/tex; mode=display">
\mathbb E_{x\sim p(x)}\mathbb E_{z\sim \mathcal N(0,I)}\frac 12\|s_\theta(x+\beta_t z)-\frac{1}{\beta_t^2}(x+\beta_t z -x)\|^2\\
\mathbb E_{x\sim p(x)}\mathbb E_{z\sim \mathcal N(0,I)}\frac 12\|s_\theta(x+\beta_t z)-\frac{1}{\beta_t}z\|^2</script><p>最终有：</p>
<script type="math/tex; mode=display">
\int_\epsilon^1dt \lambda(t)\mathbb E_{x\sim p(x)}\mathbb E_{z\sim \mathcal N(0,I)}\frac 12\|s_\theta(x+\beta_t z, t)-\frac{1}{\beta_t}z\|^2</script><p><img src="\image\Diffusion_image15.png" style="zoom: 67%;"></p>
<h3 id="DDPM"><a href="#DDPM" class="headerlink" title="DDPM"></a>DDPM</h3><p>DDPM As Discretization of Variance Preserving (VP) SDE</p>
<p>the Markov chain of the perturbation kernel of DDPM is given by</p>
<script type="math/tex; mode=display">
\boldsymbol{x}_i=\sqrt{1-\beta_i} \boldsymbol{x}_{i-1}+\sqrt{\beta_i} \boldsymbol{z}_{i-1}, \quad i=1, \cdots, L,</script><p>where $\left{\beta<em>i\right}</em>{i=1}^L$ are the noise scales, and if we take $L \rightarrow \infty$ with scaled noise scales $\overline{\beta_i}=N \beta_i$, we get</p>
<script type="math/tex; mode=display">
\boldsymbol{x}_i=\sqrt{1-\frac{\bar{\beta}_i}{N}} \boldsymbol{x}_{i-1}+\sqrt{\frac{\bar{\beta}_i}{N}} \boldsymbol{z}_{i-1}, \quad i=1, \cdots, L .</script><p>Now taking limits with $L \rightarrow \infty$, we get</p>
<script type="math/tex; mode=display">
\boldsymbol{x}(t+\Delta t) \approx \boldsymbol{x}(t)-\frac{1}{2} \beta(t) \Delta t \boldsymbol{x}(t)+\sqrt{\beta(t) \Delta t} \boldsymbol{z}(t),</script><p>where the approximation comes from the second degree Taylor expansion of $\sqrt{1-\beta(t+\Delta t) \Delta t}$. Then taking the limit of $\Delta t \rightarrow 0$, we obtain the VP SDE</p>
<script type="math/tex; mode=display">
d \boldsymbol{x}=-\frac{1}{2} \beta(t) \boldsymbol{x} d t+\sqrt{\beta(t)} d \boldsymbol{w} .</script><p>This process thus has bounded variance since $\beta_i$ is bounded.</p>
<h2 id="Unified-view-of-Diffusion-Model"><a href="#Unified-view-of-Diffusion-Model" class="headerlink" title="Unified view of Diffusion Model"></a>Unified view of Diffusion Model</h2><blockquote>
<p>这部分还没写完，有空就写写 -.-</p>
<p>Variational Based的diffusion推导：<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2208.11970.pdf">https://arxiv.org/pdf/2208.11970.pdf</a></p>
<p>from songyang</p>
</blockquote>
<p>By generalizing the number of noise scales to infinity, we further proved that score-based generative models and diffusion probabilistic models can both be viewed as discretizations to stochastic differential equations determined by score functions. This work bridges both score-based generative modeling and diffusion probabilistic modeling into a unified framework.</p>
<blockquote>
<p>from thu大佬</p>
</blockquote>
<p>可以证明，所谓的“去噪模型”与score function其实是等价的loss，这其实只需要用denoising score matching的一个性质就可以证明。有些文章里会出现“去噪”，而有些文章又会出现“估计噪声”，有些文章又会出现“score function”，但其实它们都是等价的参数化。这一点在Kingma发表在Neurips 2021的<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2107.00630">variational diffusion models</a>中也有提到。</p>
<p><img src="\image\Diffusion_image10.png" alt="image-20230704144753935" style="zoom: 50%;"></p>
<h2 id="Image-Conditional-Diffusion-and-Beyond"><a href="#Image-Conditional-Diffusion-and-Beyond" class="headerlink" title="Image, Conditional Diffusion and Beyond"></a>Image, Conditional Diffusion and Beyond</h2><blockquote>
<p>先鸽：Stable Diffusion</p>
<p>包括Unet实现、stable diffusion代码实现</p>
</blockquote>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://ludwigwinkler.github.io/blog/SDE/">https://ludwigwinkler.github.io/blog/SDE/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/536039028">https://zhuanlan.zhihu.com/p/536039028</a></p>
<p><a target="_blank" rel="noopener" href="https://yang-song.net/blog/2021/score/">https://yang-song.net/blog/2021/score/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/545910038">https://zhuanlan.zhihu.com/p/545910038</a></p>
<p><a target="_blank" rel="noopener" href="https://abdulfatir.com/blog/2020/Langevin-Monte-Carlo/">https://abdulfatir.com/blog/2020/Langevin-Monte-Carlo/</a></p>
<p><a target="_blank" rel="noopener" href="https://perceptron.blog/langevin-dynamics/">https://perceptron.blog/langevin-dynamics/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/597490389">https://zhuanlan.zhihu.com/p/597490389</a></p>
<p><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2209.04747.pdf">https://arxiv.org/pdf/2209.04747.pdf</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=rsTvWv226Fk">https://www.youtube.com/watch?v=rsTvWv226Fk</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/536012286/answer/2533146567">https://www.zhihu.com/question/536012286/answer/2533146567</a></p>
<p><a target="_blank" rel="noopener" href="https://deepgenerativemodels.github.io/assets/slides/cs236_lecture14.pdf">https://deepgenerativemodels.github.io/assets/slides/cs236_lecture14.pdf</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zxr</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://xurui314.github.io/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/">https://xurui314.github.io/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/07/01/2023-7-1/"><img class="prev-cover" src="https://www.tsinghua.edu.cn/__local/3/D6/43/55D1EDFDEEAC5CC4720BCF830F2_6E1BFFB2_C4429.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">2023/7/1</div></div></a></div><div class="next-post pull-right"><a href="/2023/06/25/MiniGPT-4/"><img class="next-cover" src="https://raw.githubusercontent.com/vision-cair/minigpt-4/master/figs/online_demo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MiniGPT-4</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2021/12/08/yTYthVwXD4IPbJ9.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">zxr</div><div class="author-info__description">Think and Do like an MIT student</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">82</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">16</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/XuRui314"><i class="fab fa-github"></i><span>This is zxr!🚀</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/XuRui314" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://mail.qq.com/" target="_blank" title="Email-1977289398@qq.com"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">zxr的生活，math，编程记录,<div class="twopeople"><div class="container" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople1.js"></script><script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/zdog.dist.js"></script><script id="rendered-js" src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople.js"></script><style>.twopeople{margin: 0;align-items: center;justify-content: center;text-align: center;}canvas{display: block;margin: 0 auto;cursor: move;}</style></div><div class="twopeople"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SDE"><span class="toc-number">2.</span> <span class="toc-text">SDE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">微分方程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Wiener-Process"><span class="toc-number">2.2.</span> <span class="toc-text">Wiener Process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">随机微分方程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ito%E2%80%99s-Lemma"><span class="toc-number">2.4.</span> <span class="toc-text">Ito’s Lemma</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fokker%E2%80%93Planck-equation"><span class="toc-number">2.5.</span> <span class="toc-text">Fokker–Planck equation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Invertible"><span class="toc-number">3.</span> <span class="toc-text">Invertible!</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Special-Case"><span class="toc-number">3.1.</span> <span class="toc-text">Special Case</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gerneral-Case"><span class="toc-number">3.2.</span> <span class="toc-text">Gerneral Case</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Magical-way-to-generate-samples"><span class="toc-number">3.3.</span> <span class="toc-text">Magical way to generate samples</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Score-based"><span class="toc-number">4.</span> <span class="toc-text">Score based</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Langevin-dynamics"><span class="toc-number">4.1.</span> <span class="toc-text">Langevin dynamics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Naive-Objective-function"><span class="toc-number">4.2.</span> <span class="toc-text">Naive Objective function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Improve-Langevin-Dynamics"><span class="toc-number">4.3.</span> <span class="toc-text">Improve Langevin Dynamics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Final-Objective-function"><span class="toc-number">4.4.</span> <span class="toc-text">Final Objective function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Combine-SDE-with-Score"><span class="toc-number">4.5.</span> <span class="toc-text">Combine SDE with Score</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Probability-flow-ODE"><span class="toc-number">4.6.</span> <span class="toc-text">Probability flow ODE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Special-Case-GMM"><span class="toc-number">4.7.</span> <span class="toc-text">Special Case GMM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DDPM"><span class="toc-number">4.8.</span> <span class="toc-text">DDPM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unified-view-of-Diffusion-Model"><span class="toc-number">5.</span> <span class="toc-text">Unified view of Diffusion Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Image-Conditional-Diffusion-and-Beyond"><span class="toc-number">6.</span> <span class="toc-text">Image, Conditional Diffusion and Beyond</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">7.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/26/2023-8-26/" title="2023/8/26"><img src="https://res.cloudinary.com/lesswrong-2-0/image/upload/f_auto,q_auto/v1/mirroredImages/YzdoNdfgfvXgC3wR4/ngkcdlubknz9mkeur95i" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2023/8/26"></a><div class="content"><a class="title" href="/2023/08/26/2023-8-26/" title="2023/8/26">2023/8/26</a><time datetime="2023-08-26T11:47:03.000Z" title="Created 2023-08-26 19:47:03">2023-08-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/26/Multimodal-Distillation/" title="Multimodal Distillation"><img src="https://media.icml.cc/Conferences/CVPR2024/img/homepage_image.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Multimodal Distillation"></a><div class="content"><a class="title" href="/2023/07/26/Multimodal-Distillation/" title="Multimodal Distillation">Multimodal Distillation</a><time datetime="2023-07-26T02:20:39.000Z" title="Created 2023-07-26 10:20:39">2023-07-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/07/Stable-Diffusion/" title="Stable Diffusion"><img src="https://scholar.harvard.edu/sites/scholar.harvard.edu/files/styles/os_files_xxlarge/public/binxuw/files/stablediffusion_overview.jpg?m=1667438590&amp;itok=n2gM0Xba" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Stable Diffusion"></a><div class="content"><a class="title" href="/2023/07/07/Stable-Diffusion/" title="Stable Diffusion">Stable Diffusion</a><time datetime="2023-07-07T14:31:01.000Z" title="Created 2023-07-07 22:31:01">2023-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/2023-7-1/" title="2023/7/1"><img src="https://www.tsinghua.edu.cn/__local/3/D6/43/55D1EDFDEEAC5CC4720BCF830F2_6E1BFFB2_C4429.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2023/7/1"></a><div class="content"><a class="title" href="/2023/07/01/2023-7-1/" title="2023/7/1">2023/7/1</a><time datetime="2023-07-01T06:01:07.000Z" title="Created 2023-07-01 14:01:07">2023-07-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/" title="Diffusion 从入门到入土"><img src="https://theaisummer.com/static/d007d60f773b61f4585cbec3869490d5/a878e/score-sde.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diffusion 从入门到入土"></a><div class="content"><a class="title" href="/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/" title="Diffusion 从入门到入土">Diffusion 从入门到入土</a><time datetime="2023-07-01T06:00:32.000Z" title="Created 2023-07-01 14:00:32">2023-07-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">©2020 - 2023 By zxr</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="github-badge"><a style="color: #fff" rel="license" href="https://hexo.io/" target="_blank" title="由 Hexo 强力驱动"><span class="badge-subject">Powered</span><span class="badge-value bg-blue">Hexo</span></a><a style="color: #fff" rel="license" href="https://gitee.com/" target="_blank" title="静态网页托管于 GitHub Pages 和 Coding Pages 和 Gitee Pages"><span class="badge-subject">Hosted</span><span class="badge-value bg-brightgreen">GitHub &amp; Coding &amp; Gitee</span></a><a style="color: #fff" rel="license" href="https://www.jsdelivr.com/" target="_blank" title="jsDelivr 提供 CDN 加速服务"><span class="badge-subject">CDN</span><span class="badge-value bg-orange">jsDelivr</span></a><a style="color: #fff" rel="license" href="https://jerryc.me" target="_blank" title="站点使用 Butterfly主题"><span class="badge-subject">Theme</span><span class="badge-value bg-blue">Butterfly</span></a><a style="color: #fff" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="本站点采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议进行许可"><span class="badge-subject"><i class="fa fa-copyright"></i></span><span class="badge-value bg-lightgrey">BY-NC-SA 4.0  </span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = '[object Object]'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://xurui314.github.io/2023/07/01/Diffusion-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F/'
    this.page.identifier = '2023/07/01/Diffusion-从入门到入土/'
    this.page.title = 'Diffusion 从入门到入土'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script src="https://cdn.jsdelivr.net/gh/XuRui314/live2d-widget@1.0.1/autoload.js"></script><script src="/js/title.js"></script><script src="/dist/nochocolate.js"></script><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax="">if(document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/Math/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 zxrの数学世界 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/算法学习/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 zxrの算法学习 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/生活趣闻/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 zxrの生活趣闻 (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/编程实例/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 zxrの编程学习 (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/生活感悟/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🚴‍♂ zxrの生活感悟 (11)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://XuRui314.github.io/categories/Hexo/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💌 zxrのBlog记录 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://XuRui314.github.io/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #b30070}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style> <script data-pjax="">if(document.getElementById('recent-posts') && location.pathname =='/'){
    
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/09/17/9H5WSbTrVejOdkz.jpg" alt="https://i.loli.net/2021/09/17/9H5WSbTrVejOdkz.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-09-17</span><a class="blog-slider__title" href="2021/09/17/概率和测度/">概率和测度(ZJU大佬)</a><div class="blog-slider__text">来看看ZJU计科大佬解释概率和测度🥙</div><a class="blog-slider__button" href="2021/09/17/概率和测度/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/25/bPy5m3j9QAilwr2.jpg" alt="https://i.loli.net/2021/08/25/bPy5m3j9QAilwr2.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-08-26</span><a class="blog-slider__title" href="2021/08/26/算法题目练习/">AcWing-Oj-刷题学习记录(基础算法)</a><div class="blog-slider__text">来看算法蒟蒻的丢人日常啊👩‍🦽</div><a class="blog-slider__button" href="2021/08/26/算法题目练习/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/15/NYcSXrECnvzOiLP.jpg" alt="https://i.loli.net/2021/08/15/NYcSXrECnvzOiLP.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-08-15</span><a class="blog-slider__title" href="2021/08/15/两层神经网络识别手写数字/">两层神经网络识别手写数字</a><div class="blog-slider__text">识别手写数字最简单的实现🧦</div><a class="blog-slider__button" href="2021/08/15/两层神经网络识别手写数字/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/15/F8aP7R36IidpCt5.jpg" alt="https://i.loli.net/2021/08/15/F8aP7R36IidpCt5.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-08-14</span><a class="blog-slider__title" href="2021/08/14/神经网络搭建准备内容/">神经网络搭建准备内容</a><div class="blog-slider__text">如何识别手写🔢，zxr带你一步一步实现🎼</div><a class="blog-slider__button" href="2021/08/14/神经网络搭建准备内容/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/12/SJs3MgYC7x8IU26.jpg" alt="https://i.loli.net/2021/08/12/SJs3MgYC7x8IU26.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-08-12</span><a class="blog-slider__title" href="2021/08/12/xuperchain-solidity/">xuperchain&solidity</a><div class="blog-slider__text">区块链不止是挖币，还有v神和solidity🎈</div><a class="blog-slider__button" href="2021/08/12/xuperchain-solidity/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/07/27/6fy8mTCbAOWPkrq.png" alt="https://i.loli.net/2021/07/27/6fy8mTCbAOWPkrq.png"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-07-26</span><a class="blog-slider__title" href="2021/07/26/FFT/">FFT的详解</a><div class="blog-slider__text">这么好看的FFT，信号狗都馋哭了💦</div><a class="blog-slider__button" href="2021/07/26/FFT/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/09/zdt4YKoehQvR96S.jpg" alt="https://i.loli.net/2021/08/09/zdt4YKoehQvR96S.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-08-09</span><a class="blog-slider__title" href="2021/08/09/炒鸡好理解的测度论/">炒鸡好理解的测度论</a><div class="blog-slider__text">三段字，让你读懂测度论</div><a class="blog-slider__button" href="2021/08/09/炒鸡好理解的测度论/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/08/12/wF7TJlqxOLEWGQk.png" alt="https://i.loli.net/2021/08/12/wF7TJlqxOLEWGQk.png"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-07-27</span><a class="blog-slider__title" href="2021/07/27/FT/">傅里叶学习资料</a><div class="blog-slider__text">简单好学的傅里叶学习资料</div><a class="blog-slider__button" href="2021/07/27/FT/">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src="https://i.loli.net/2021/07/27/f7jO8hlNpzWVXSP.jpg" alt="https://i.loli.net/2021/07/27/f7jO8hlNpzWVXSP.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2021-07-26</span><a class="blog-slider__title" href="2021/07/26/hello-world/">大鸟转转转酒吧内部绝密档案</a><div class="blog-slider__text">不要点进来QAQ！</div><a class="blog-slider__button" href="2021/07/26/hello-world/">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载swiper')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script>
<script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script>
<script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script>
<style></style><script data-pjax="">function electric_clock_injector_config(){
                var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
                var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img id="card-clock-loading" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-clock/clock/images/weather/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading" class="entered loading"></div></div></div></div></div>';
                console.log('已挂载electric_clock')
                // parent_div_git.innerHTML=item_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",item_html) // 有报错，但不影响使用(支持pjax跳转)
            }if( document.getElementsByClassName('sticky_layout')[0] && (location.pathname ==='all'|| 'all' ==='all')){

            electric_clock_injector_config()
        } </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/hexo-electric-clock@1.0.6/clock.js"></script>
  <script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax="">
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?XuRui314";
            var git_color =['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'];
            var git_user ="XuRui314";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_loading" style="height:100%;display: flex;align-items: center;justify-content: center;"><svg style="height:50px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:248px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style></style><script async="" src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-wanko"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>